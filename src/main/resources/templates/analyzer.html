<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/layout}"
>
  <head>
    <title>Crawler & Analyzer</title>
  </head>
  <body>
    <div layout:fragment="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Vulnerability Crawling</h4>
                <h6 class="card-subtitle mb-3">
                  Click the button below to start crawling and analyzing vulnerabilities.
                </h6>
                <button type="button" id="start-crawl-btn" class="btn btn-primary">
                  <i class="ti ti-search"></i> 크롤링 및 분석 시작
                </button>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Analysis Results</h4>
                
                <div class="row">
                  <div class="col-12">
                    <h5 class="card-subtitle mb-3">Vulnerabilities by Language</h5>
                    <div id="summary-chart"></div>
                  </div>
                </div>

                <hr/>

                <div class="row mt-4">
                  <div class="col-12">
                    <h5 class="card-subtitle mb-3">Vulnerability Details</h5>
                    <div class="table-responsive">
                      <table id="detail-table" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                          <tr>
                            <th>Language</th>
                            <th>Kingdom</th>
                            <th>Title</th>
                            <th>Numeric ID</th>
                          </tr>
                        </thead>
                        <tbody>
                          </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                
              </div>
            </div>
          </div>

        </div>
        </div>
    </div>

    <th:block layout:fragment="script">
      <script>
        // ★★★ 기존 크롤러 실행 버튼 로직 ★★★
        document.getElementById("start-crawl-btn").addEventListener("click", function () {
            Swal.fire({
              title: "작업을 시작할까요?",
              text: "크롤링 및 분석 작업은 시간이 다소 소요될 수 있습니다.",
              icon: "question",
              showCancelButton: true,
              confirmButtonText: "네, 시작하겠습니다.",
              cancelButtonText: "아니요, 취소합니다."
            }).then((result) => {
              if (result.isConfirmed) {
                Swal.fire({
                  title: '백그라운드 작업 시작됨',
                  text: '크롤링 및 분석을 시작합니다. 서버 로그를 확인하세요.',
                  icon: 'info',
                  allowOutsideClick: false,
                  showConfirmButton: false
                });

                fetch("/analyzer/crawl/execute", { method: "POST" })
                  .then(response => {
                    if (!response.ok) throw new Error("Server error: " + response.statusText);
                    return response.text();
                  })
                  .then(data => {
                    Swal.fire('요청 성공!', '작업이 백그라운드에서 시작되었습니다. 완료 후 페이지를 새로고침하여 결과를 확인하세요.', 'success');
                  })
                  .catch(error => {
                    Swal.fire('요청 실패', '작업 시작에 실패했습니다: ' + error.message, 'error');
                  });
              }
            });
        });

        // ★★★★★ 새로 추가된 분석 결과 로딩 및 표시 로직 ★★★★★
        document.addEventListener("DOMContentLoaded", function () {
          loadAnalysisResults();
        });

        function loadAnalysisResults() {
          const summaryUrl = "/analyzer/api/analysis/summary";
          const detailUrl = "/analyzer/api/analysis/detail";

          Promise.all([fetch(summaryUrl), fetch(detailUrl)])
            .then(responses => Promise.all(responses.map(res => res.json())))
            .then(([summaryData, detailData]) => {
              if (!summaryData.error) {
                renderSummaryChart(summaryData.by_language);
              }
              if (!detailData.error) {
                renderDetailTable(detailData.by_language);
              }
            })
            .catch(error => {
              console.error("Error fetching analysis data:", error);
              Swal.fire('데이터 로딩 실패', '분석 결과를 불러오는 중 오류가 발생했습니다.', 'error');
            });
        }
        
        // ApexCharts를 사용하여 요약 차트 렌더링
        function renderSummaryChart(data) {
          const languages = Object.keys(data);
          const vulnerabilityCounts = languages.map(lang => {
            const kingdoms = data[lang];
            return Object.values(kingdoms).reduce((sum, count) => sum + count, 0);
          });

          const options = {
            series: [{
              name: 'Vulnerabilities',
              data: vulnerabilityCounts
            }],
            chart: {
              type: 'bar',
              height: 350
            },
            plotOptions: {
              bar: {
                horizontal: true,
              }
            },
            xaxis: {
              categories: languages
            },
            tooltip: {
              y: {
                formatter: function (val) {
                  return val + " vulnerabilities"
                }
              }
            }
          };

          const chart = new ApexCharts(document.querySelector("#summary-chart"), options);
          chart.render();
        }

        // DataTables를 사용하여 상세 테이블 렌더링
        function renderDetailTable(data) {
            const tableData = [];
            for (const language in data) {
                if (data.hasOwnProperty(language)) {
                    data[language].forEach(vuln => {
                        tableData.push({
                            language: language.replace(/_/g, ' '),
                            kingdom: vuln.kingdom,
                            title: vuln.title,
                            numeric_id: vuln.numeric_id
                        });
                    });
                }
            }

            $('#detail-table').DataTable({
                data: tableData,
                columns: [
                    { data: 'language' },
                    { data: 'kingdom' },
                    { data: 'title' },
                    { data: 'numeric_id' }
                ],
                responsive: true
            });
        }
      </script>
    </th:block>
  </body>
</html>